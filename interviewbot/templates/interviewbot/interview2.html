<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interview</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body style="background-color: #f8f9fa;">
  <div class="container py-5">
    <div class="row justify-content-center g-5">
      
      <!-- üé• Video Preview Area -->
      <div class="col-md-6 text-center">
        <h5 class="mb-3">Live Video Preview</h5>
        <div class="border rounded shadow-sm p-2 bg-dark">
          <video id="videoPreview"
                 autoplay muted
                 style="width: 100%; height: 400px; object-fit: cover; border-radius: 6px;">
          </video>
        </div>
      </div>

      <!-- ‚ùì Interview Question and Answer -->
      <div class="col-md-6 align-items-center">
        <h2 class="mb-3">Interview Question</h2>
        <p id="question" class="fs-5 fw-semibold text-primary">Loading question...</p>
        <p id="timer" class="text-danger fs-4 fw-bold">03:00</p>


        <!-- Hidden input to store the transcript -->
        <input type="hidden" id="answerInput">

        <button id="nextButton" class="btn btn-success mb-3" onclick="submitAndNext()">Next ‚û°Ô∏è</button>

        <p id="result" class="fs-5 fw-bold"></p>
        <p id="error" class="text-danger fw-bold"></p>
        <div id="loadingNext" class="d-none mt-3 text-center">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Loading next question...</p>
        </div>

      </div>
    </div>
  </div>

  <!-- üß† JavaScript for Recording & Question Handling -->
  <script>
let recorder = null;
let videoStream = null;
let recordedChunks = [];
let timerInterval = null;
let timeLeft = 180;

function startTimer() {
  clearInterval(timerInterval);
  timeLeft = 180;
  updateTimerDisplay();

  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerDisplay();

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      autoSubmitAndNext();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
  const seconds = (timeLeft % 60).toString().padStart(2, '0');
  document.getElementById('timer').innerText = `${minutes}:${seconds}`;
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

function loadQuestion() {
  fetch('/interviewbot/get-question/')
    .then(res => res.json())
    .then(data => {
      if (data.done) {
        document.getElementById('question').innerText = "üéâ Interview Complete!";
        document.getElementById('answerInput').style.display = "none";
        document.getElementById('nextButton').style.display = "none";
        stopInterview();
        clearInterval(timerInterval);

        const tryAgainBtn = document.createElement("button");
        tryAgainBtn.innerText = "üîÅ Try Again";
        tryAgainBtn.className = "btn btn-warning";
        tryAgainBtn.onclick = restartInterview;
        tryAgainBtn.id = "tryAgainButton";
        document.querySelector('.col-md-6.align-items-center').appendChild(tryAgainBtn);
        return;
      }

      document.getElementById('question').innerText = data.question;
      document.getElementById('answerInput').value = '';
      document.getElementById('result').innerText = '';
      document.getElementById('error').innerText = '';
      recordedChunks = [];

      startTimer();
      startInterview();
    });
}

function startInterview() {
 navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(stream => {
      videoStream = stream;
      document.getElementById('videoPreview').srcObject = stream;

      recordedChunks = [];

      recorder = new MediaRecorder(stream, {
        mimeType: "video/webm; codecs=vp8,opus"
      });

       recorder.ondataavailable = e => {
        if (e.data && e.data.size > 0) {
          recordedChunks.push(e.data);
          console.log("Received data chunk size:", e.data.size);
        }
      };

      recorder.start();
    })
    .catch(err => {
      document.getElementById('error').innerText = "Camera/Mic error: " + err;
    });
}

function stopInterview() {
  if (recorder && recorder.state !== "inactive") recorder.stop();
  if (videoStream) videoStream.getTracks().forEach(track => track.stop());
}

function submitAndNext() {
  clearInterval(timerInterval);
  // stopInterview();
  submitAnswer(false);
}

function autoSubmitAndNext() {
  clearInterval(timerInterval);
  // stopInterview();
  submitAnswer(true);
}

function submitAnswer(isAuto) {
  if (recorder && recorder.state === "recording") {
    // Attach onstop handler to finalize after recording ends
    recorder.onstop = () => {
      console.log("Recorder stopped. Total chunks:", recordedChunks.length);
      const totalSize = recordedChunks.reduce((s, b) => s + b.size, 0);
      console.log("Final blob size:", totalSize);
      sendAnswer(isAuto);
    };
    recorder.stop(); // This triggers final ondataavailable
  } else {
    // Already stopped
    sendAnswer(isAuto);
  }
}


function sendAnswer(isAuto) {
  console.log("Recorded chunks:", recordedChunks);
const totalSize = recordedChunks.reduce((sum, blob) => sum + blob.size, 0);
console.log("Total blob size:", totalSize, "bytes");
  const videoBlob = new Blob(recordedChunks, { type: "video/webm" });
  const formData = new FormData();
  formData.append('video', videoBlob, 'interview.webm');

  document.getElementById('loadingNext').classList.remove('d-none');

  fetch('/interviewbot/submit-answer/', {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById('result').innerText = isAuto ? "‚è≥ Time's up! Auto-submitted." : "";
    setTimeout(() => {
      loadQuestion();
      document.getElementById('loadingNext').classList.add('d-none');
    }, 1000);
  });
}

function restartInterview() {
  fetch('/interviewbot/reset/', {
    method: 'POST',
    headers: { 'X-CSRFToken': getCookie('csrftoken') }
  }).then(() => {
    document.getElementById('answerInput').style.display = "inline";
    document.getElementById('nextButton').style.display = "inline";
    document.getElementById('tryAgainButton')?.remove();
    loadQuestion();
  });
}

loadQuestion();
</script>


</body>
</html>
